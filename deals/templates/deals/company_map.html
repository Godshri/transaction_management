{% extends 'deals/base.html' %}
{% load static %}

{% block title %}Карта компаний - Управление сделками{% endblock %}

{% block extra_head %}
    <script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_api_key }}&lang=ru_RU" type="text/javascript"></script>
    <style>
        .map-container {
            margin: 20px 0;
        }

        #map {
            width: 100%;
            height: 600px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #ddd;
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .map-stats {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .company-balloon {
            padding: 10px;
            max-width: 300px;
            font-family: Arial, sans-serif;
        }

        .company-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            font-size: 16px;
        }

        .company-description {
            margin-bottom: 10px;
            font-size: 14px;
            color: #555;
            line-height: 1.4;
        }

        .company-address {
            font-size: 13px;
            color: #666;
            border-top: 1px solid #eee;
            padding-top: 8px;
            margin-top: 8px;
        }

        .company-logo {
            max-width: 100px;
            max-height: 60px;
            margin: 8px 0;
            object-fit: contain;
            border-radius: 4px;
            display: block;
        }

        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
            flex-direction: column;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }
                .company-balloon {
            padding: 10px;
            max-width: 250px;
        }

        .company-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        .company-logo {
            max-width: 100px;
            max-height: 60px;
            margin: 8px 0;
            object-fit: contain;
            border-radius: 4px;
        }

        /* Стили для кастомных меток */
        .ymaps-2-1-79-image-with-content {
            background: transparent !important;
        }
    </style>
{% endblock %}

{% block content %}
<div class="map-header">
    <h1>Карта компаний</h1>
    <div class="header-actions">
        <button onclick="refreshMap()" class="btn btn-primary">Обновить карту</button>
    </div>
</div>

{% if error %}
    <div class="error-message">
        <strong>Ошибка:</strong> {{ error }}
    </div>
{% endif %}

<div class="map-stats">
    <p>Найдено компаний: <strong id="companies-count">{{ points|length }}</strong></p>
    <p>Компаний с координатами: <strong id="geocoded-count">{{ points|length }}</strong></p>
</div>

<div class="map-container">
    {% if points %}
        <div id="map"></div>
    {% else %}
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Загрузка данных компаний...</p>
            {% if not error %}
                <p>Если данные не загружаются, попробуйте <a href="javascript:location.reload()">обновить страницу</a></p>
            {% endif %}
        </div>
    {% endif %}
</div>

<script>
    // Инициализация карты после загрузки API
    ymaps.ready(init);

    function init() {
        // Создаем карту
        var map = new ymaps.Map('map', {
            center: [55.76, 37.64],
            zoom: 10,
            controls: ['zoomControl', 'fullscreenControl', 'typeSelector']
        });

        // Данные точек из Django контекста
        var points = {{ points|safe }};

        if (points.length === 0) {
            // Если нет точек, показываем сообщение
            var noDataControl = new ymaps.Control({
                content: '<div style="padding: 10px; background: white; border-radius: 5px;">' +
                         '<p>Нет данных для отображения на карте</p>' +
                         '<button onclick="refreshMap()" style="padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">Обновить</button>' +
                         '</div>',
                position: {top: 10, left: 10}
            });
            map.controls.add(noDataControl);
            return;
        }

        // Создаем коллекцию Placemark вместо ObjectManager для кастомных иконок
        var objectCollection = new ymaps.GeoObjectCollection(null, {
            preset: 'islands#blueIcon',
            clusterize: true,
            gridSize: 64,
            clusterDisableClickZoom: true
        });

        // Добавляем точки на карту с кастомными иконками
        points.forEach(function(point, index) {
            // Создаем кастомную иконку с логотипом
            var iconContent = point.LogoURL ?
                '<img src="' + point.LogoURL + '" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">' :
                '<div style="width: 40px; height: 40px; border-radius: 50%; background: #007bff; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">' +
                (point.TITLE ? point.TITLE.charAt(0).toUpperCase() : 'C') +
                '</div>';

            var placemark = new ymaps.Placemark(point.GEOCODE, {
                    balloonContentHeader: '<div class="company-name">' + point.TITLE + '</div>',
                    balloonContentBody: `
                        <div class="company-balloon">
                            ${point.DESCRIPTION ?
                                '<div class="company-description" style="margin-bottom: 10px; font-size: 13px; color: #666;">' +
                                point.DESCRIPTION +
                                '</div>' :
                                ''}
                            ${point.ADDRESS ?
                                '<div class="company-address" style="font-size: 12px; color: #888; border-top: 1px solid #eee; padding-top: 8px; margin-top: 8px;">' +
                                '<strong>Адрес:</strong> ' + point.ADDRESS +
                                '</div>' :
                                ''}
                            ${point.LogoURL ?
                                `<img src="${point.LogoURL}" alt="Логотип" class="company-logo"
                                      onerror="this.style.display='none'" style="margin-top: 10px;">` :
                                ''}
                        </div>
                    `,
                    hintContent: point.TITLE
                }, {
                // Настройки иконки
                iconLayout: 'default#imageWithContent',
                iconImageHref: '', // Пустая строка, чтобы не показывать стандартную иконку
                iconImageSize: [50, 50],
                iconImageOffset: [-25, -25],

                // Настройки контента внутри иконки
                iconContentLayout: ymaps.templateLayoutFactory.createClass(
                    '<div style="background: transparent; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">' +
                    iconContent +
                    '</div>'
                ),
                iconContentOffset: [0, 0],
                iconContentSize: [50, 50],

                // Настройки балуна
                balloonCloseButton: true,
                balloonPanelMaxMapArea: 0
            });

            objectCollection.add(placemark);
        });

        map.geoObjects.add(objectCollection);

        // Если есть точки, центрируем карту на них
        if (points.length > 0) {
            var bounds = objectCollection.getBounds();
            if (bounds) {
                map.setBounds(bounds, {
                    checkZoomRange: true,
                    zoomMargin: 50
                });
            }
        }

        // Добавляем поиск на карту
        var searchControl = new ymaps.control.SearchControl({
            options: {
                float: 'right',
                floatIndex: 200,
                noPlacemark: true,
                placeholder: 'Поиск компаний...'
            }
        });
        map.controls.add(searchControl);

        // Обработчик поиска
        searchControl.events.add('resultselect', function (e) {
            var index = e.get('index');
            searchControl.getResult(index).then(function (res) {
                map.setCenter(res.geometry.getCoordinates(), 15);
            });
        });
        
        // Добавляем масштабирование колесом мыши
        map.behaviors.enable('scrollZoom');
    }
    
    function refreshMap() {
        location.reload();
    }
    
    // Обновляем счетчики
    document.addEventListener('DOMContentLoaded', function() {
        var points = {{ points|safe }};
        document.getElementById('companies-count').textContent = points.length;
        document.getElementById('geocoded-count').textContent = points.length;
    });
</script>
{% endblock %}