{% extends 'deals/base.html' %}
{% load static %}

{% block title %}Карта компаний - Управление сделками{% endblock %}

{% block extra_head %}
    <script src="https://api-maps.yandex.ru/2.1/?apikey=221b42f7-a786-407f-9650-803a69dd7ba6&lang=ru_RU" type="text/javascript"></script>
    <style>
        .map-container {
            margin: 20px 0;
        }

        #map {
            width: 100%;
            height: 600px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #ddd;
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .map-stats {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .company-balloon {
            padding: 10px;
            max-width: 250px;
        }

        .company-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        .company-logo {
            max-width: 100px;
            max-height: 60px;
            margin: 8px 0;
            object-fit: contain;
            border-radius: 4px;
        }

        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
            flex-direction: column;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }
    </style>
{% endblock %}

{% block content %}
<div class="map-header">
    <h1>Карта компаний</h1>
    <div class="header-actions">
        <button onclick="refreshMap()" class="btn btn-primary">Обновить карту</button>
    </div>
</div>

{% if error %}
    <div class="error-message">
        <strong>Ошибка:</strong> {{ error }}
    </div>
{% endif %}

<div class="map-stats">
    <p>Найдено компаний: <strong id="companies-count">{{ points|length }}</strong></p>
    <p>Компаний с координатами: <strong id="geocoded-count">{{ points|length }}</strong></p>
</div>

<div class="map-container">
    {% if points %}
        <div id="map"></div>
    {% else %}
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Загрузка данных компаний...</p>
            {% if not error %}
                <p>Если данные не загружаются, попробуйте <a href="javascript:location.reload()">обновить страницу</a></p>
            {% endif %}
        </div>
    {% endif %}
</div>

<script>
    // Инициализация карты после загрузки API
    ymaps.ready(init);

    function init() {
        // Создаем карту
        var map = new ymaps.Map('map', {
            center: [55.76, 37.64], // Москва по умолчанию
            zoom: 10,
            controls: ['zoomControl', 'fullscreenControl', 'typeSelector']
        });

        // Данные точек из Django контекста
        var points = {{ points|safe }};

        if (points.length === 0) {
            // Если нет точек, показываем сообщение
            var noDataControl = new ymaps.Control({
                content: '<div style="padding: 10px; background: white; border-radius: 5px;">' +
                         '<p>Нет данных для отображения на карте</p>' +
                         '<button onclick="refreshMap()" style="padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">Обновить</button>' +
                         '</div>',
                position: {top: 10, left: 10}
            });
            map.controls.add(noDataControl);
            return;
        }

        // Создаем коллекцию меток
        var objectManager = new ymaps.ObjectManager({
            clusterize: true,
            gridSize: 64,
            clusterDisableClickZoom: true,
            clusterIconColor: '#007bff'
        });

        // Настройка внешнего вида меток
        objectManager.objects.options.set({
            preset: 'islands#blueCompanyIcon',
            iconColor: '#007bff',
            balloonCloseButton: true
        });

        objectManager.clusters.options.set({
            preset: 'islands#blueClusterIcons',
            clusterDisableClickZoom: true
        });

        map.geoObjects.add(objectManager);

        // Добавляем точки на карту
        var features = points.map(function(point, index) {
            return {
                type: 'Feature',
                id: index,
                geometry: {
                    type: 'Point',
                    coordinates: point.GEOCODE
                },
                properties: {
                    balloonContentHeader: '<div class="company-name">' + point.TITLE + '</div>',
                    balloonContentBody: `
                        <div class="company-balloon">
                            ${point.LogoURL ?
                                `<img src="${point.LogoURL}" alt="Логотип" class="company-logo"
                                      onerror="this.style.display='none'">` :
                                ''}
                        </div>
                    `,
                    clusterCaption: point.TITLE,
                    hintContent: point.TITLE
                }
            };
        });

        objectManager.add({
            type: 'FeatureCollection',
            features: features
        });

        // Если есть точки, центрируем карту на них
        if (points.length > 0) {
            var bounds = objectManager.getBounds();
            if (bounds) {
                map.setBounds(bounds, {
                    checkZoomRange: true,
                    zoomMargin: 50
                });
            }
        }

        // Добавляем поиск на карту
        var searchControl = new ymaps.control.SearchControl({
            options: {
                float: 'right',
                floatIndex: 200,
                noPlacemark: true,
                placeholder: 'Поиск компаний...'
            }
        });
        map.controls.add(searchControl);

        // Обработчик поиска
        searchControl.events.add('resultselect', function (e) {
            var index = e.get('index');
            searchControl.getResult(index).then(function (res) {
                map.setCenter(res.geometry.getCoordinates(), 15);
            });
        });
        
        // Добавляем масштабирование колесом мыши
        map.behaviors.enable('scrollZoom');
    }
    
    function refreshMap() {
        location.reload();
    }
    
    // Обновляем счетчики
    document.addEventListener('DOMContentLoaded', function() {
        var points = {{ points|safe }};
        document.getElementById('companies-count').textContent = points.length;
        document.getElementById('geocoded-count').textContent = points.length;
    });
</script>
{% endblock %}