{% extends 'deals/base.html' %}
{% load static %}

{% block title %}Карта компаний - Управление сделками{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/company_map.css' %}">
{% endblock %}

{% block extra_head %}
    <script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_api_key }}&lang=ru_RU" type="text/javascript"></script>
{% endblock %}

{% block content %}
<div class="map-header">
    <h1>Карта компаний</h1>
    <div class="header-actions">
        <button onclick="refreshMap()" class="button">Обновить карту</button>
    </div>
</div>

{% if error %}
    <div class="error-message">
        <strong>Ошибка:</strong> {{ error }}
    </div>
{% endif %}

<div class="map-stats">
    <p>Найдено компаний: <strong id="companies-count">{{ points|length }}</strong></p>
    <p>Компаний с координатами: <strong id="geocoded-count">{{ points|length }}</strong></p>
</div>

<div class="map-container">
    {% if points %}
        <div id="map"></div>
    {% else %}
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Загрузка данных компаний...</p>
            {% if not error %}
                <p>Если данные не загружаются, попробуйте <a href="javascript:location.reload()">обновить страницу</a></p>
            {% endif %}
        </div>
    {% endif %}
</div>

<script>
    // Передаем данные из Django в JavaScript
    window.points = {{ points|safe }};
</script>
{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/company_map.js' %}"></script>
{% endblock %}